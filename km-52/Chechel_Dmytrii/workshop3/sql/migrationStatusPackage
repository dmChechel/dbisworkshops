CREATE OR REPLACE PACKAGE MIGRATION_STATUS_PACKAGE AS
  TYPE T_MIGRATION_STATUS IS RECORD (
  MIGRATION_ID NUMBER,
  MIGRATION_STATUS_ID NUMBER,
  TIMESTAMP DATETIME
  );

  TYPE T_MIGRATION_STATUS_TABLE IS TABLE OF T_MIGRATION_STATUS;

  FUNCTION GET_CURRENT_MIGRATION_STATUS(MR_ID IN MIGRATION_REQUESTS.ID%TYPE)
    RETURN T_MIGRATION_STATUS_TABLE PIPELINED;
    
 PROCEDURE SET_NEW_MIGRATION_STATUS(MR_ID IN MIGRATION_REQUESTS.ID%TYPE, MR_STATUS_STRING IN MIGRATION_STATUSES.STATUS_NAME%TYPE);
END;

CREATE OR REPLACE PACKAGE BODY MIGRATION_STATUS_PACKAGE AS
  FUNCTION GET_CURRENT_MIGRATION_STATUS(MR_ID IN GET_MIGRATION_REQUEST.ID%type)
    RETURN T_MIGRATION_STATUS_TABLE PIPELINED AS
    CURSOR MY_CUR IS
      SELECT *
      FROM MIGRATION_STATUS
      WHERE MIGRATION_STATUS.MIGRATION_ID = MR_ID
      ORDER BY MIGRATION_STATUS.TIMESTAMP DESC LIMIT 1;
    BEGIN
      FOR CURR IN MY_CUR
      LOOP
        PIPE ROW (CURR);
      end loop;
    END;
    
    PROCEDURE SET_NEW_MIGRATION_STATUS(MR_ID IN MIGRATION_REQUESTS.ID%TYPE, MR_STATUS_STRING IN MIGRATION_STATUSES.STATUS_NAME%TYPE) AS
      MR_STATUS_ID NUMBER;
    BEGIN
      SELECT ID INTO MR_STATUS_ID FROM MIGRATION_STATUSES WHERE STATUS_NAME = MR_STATUS_STRING;
      INSERT INTO MIGRATION_STATUS (MIGRATION_ID, MIGRATION_STATUS_ID) VALUES (MR_ID, MR_STATUS_ID);
    END;
END SONG_PACKAGE;
  /
select * from table (MIGRATION_STATUS_PACKAGE.GET_CURRENT_MIGRATION_STATUS(1));
